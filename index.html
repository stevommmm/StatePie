<!DOCTYPE html>
<html>
<head>
	<title>StatePie</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<!--[if lte IE 8]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script><![endif]-->
	<script type="text/javascript" src="/static/pie.js"></script>
	<script type="text/javascript" src="/static/main.js"></script>
	<link rel="stylesheet" href="/static/main.css" />
</head>
<body>
	<div class="wrapper">
		<noscript>
			<p style="text-align:center;">You seem to have javascript disabled. This site won't work without it sorry :(</p>
		</noscript>
		<div class="metric" id="options"></div>
		<span id="dynamic"></span>
	</div>
	<script type="text/javascript">
		/* Remove items from our appended csv, we only want to show the latest value */
		function uniq(a) {
		    var seen = {};
		    return a.reverse().filter(function(item) {
		        return seen.hasOwnProperty(item[0]) ? false : (seen[item[0]] = true);
		    });
		}

		/* priority sorter */
		function sortPriority(a, b) {
			if (a[1] > b[1])
				return -1;
			if (a[1] < b[1])
				return 1;
			return 0;
		}
		
		function rowConsumer(rawblob) {
			var wrapper = document.getElementById('dynamic');
			var regexsplit = RegExp("[^\"]+\"|'[^']+'|[^,]+", "g"); // Hacky CSV parser

			wrapper.innerHTML = '';

			var rows = rawblob.split('\n').map(function( i) { return i.match(regexsplit); });
			rows = uniq(rows);

			if (OPTIONS['sortPriority']) {
				// rows.sort(sortPriority);
				rows.sort(function(a, b) {return b[1] - a[1]; });
				console.log(rows);
			}


			for (row of rows) {
				// rawsplit = row.match(regexsplit);
				new Pie(row[1], row[2], row[0]).renderTo(wrapper,  OPTIONS);
			}
		}

		window.onload = function() {
			var oele = document.getElementById('options');
			oele.appendChild(generateOptionElement('sortPriority', 'Sort by Percent'));
			oele.appendChild(generateOptionElement('expandAlert', 'Expand Alerts'));
			oele.appendChild(generateOptionElement('expandWarn', 'Expand Warnings'));
			oele.appendChild(generateOptionElement('expandNormal', 'Expand Normal'));

			// setTimeout(function getMetrics() {
			//     makeRequest('/static/state.json?t=' + Date.now(), parseJSONCallback);
			//     setTimeout(getMetrics, 60000);
			// }, 0);

			makeRequest("/static/state.csv?t=" + Date.now(), rowConsumer);
		}
	</script>
</body>
</html>